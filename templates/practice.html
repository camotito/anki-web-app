<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anki Web - Practice</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <div style="text-align: right; margin-bottom: 20px;">
            <a href="/logout" class="button" style="color: white; background-color: #007BFF; padding: 10px 20px; border-radius: 5px; text-decoration: none;">Logout</a>
        </div>
        <div id="card-container">
            <div id="no-cards-due" class="hidden" style="text-align: center;">
                <h2>üìÖ No Cards Due</h2>
                <p>You're all caught up! There are no cards due for review right now.</p>
                {% if next_review %}
                <p>Next review scheduled for: <strong>{{ next_review.strftime('%Y-%m-%d %H:%M') }}</strong></p>
                {% else %}
                <p>All your cards have been reviewed. They will become available based on their spaced repetition schedule.</p>
                {% endif %}
            </div>
            <div id="practice-complete" class="hidden" style="text-align: center;">
                <h2>üéâ Practice Complete! üéâ</h2>
                <p>Great job! You've reviewed all your due cards.</p>
                <p>Come back later when cards are ready for review according to their spaced repetition schedule.</p>
            </div>
            <div id="practice-content">
                <div id="card">
                    <div id="front" class="card-side">
                        <p id="question"></p>
                    </div>
                    <div id="back" class="card-side hidden">
                        <p id="answer"></p>
                    </div>
                </div>
                <button id="show-answer" class="button">Show Answer</button>
                <div id="answer-buttons" class="hidden" style="display: none;">
                    <button class="button again" onclick="answerCard(1)">Imposible</button>
                    <button class="button hard" onclick="answerCard(2)">Hard</button>
                    <button class="button good" onclick="answerCard(3)">Good</button>
                    <button class="button easy" onclick="answerCard(4)">Easy</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCardId = null;
        let cardQueue = []; // Cola de tarjetas precargadas

        async function startPractice() {
            const response = await fetch('/start-practice');
            const data = await response.json();
            if (data.success) {
                // Cargar un lote de tarjetas inmediatamente
                await loadCardBatch();
                // Mostrar la primera tarjeta
                showNextCardFromQueue();
            } else if (data.error === "No cards due for review") {
                document.getElementById('practice-content').classList.add('hidden');
                document.getElementById('no-cards-due').classList.remove('hidden');
            } else {
                alert('Error: ' + data.error);
            }
        }

        async function loadCardBatch() {
            try {
                console.log("üîÑ Solicitando nuevo lote de tarjetas...");
                const response = await fetch('/card-batch');
                const data = await response.json();
                if (response.ok) {
                    // A√±adir las nuevas tarjetas a la cola
                    cardQueue = cardQueue.concat(data.cards);
                    console.log(`‚úÖ Lote cargado: ${data.cards.length} tarjetas a√±adidas a la cola. Total en cola: ${cardQueue.length}`);
                    console.log(`‚ÑπÔ∏è Tarjetas restantes por cargar: ${data.remainingCards}`);
                    return data.remainingCards > 0;
                }
                return false;
            } catch (error) {
                console.error("‚ùå Error loading card batch:", error);
                return false;
            }
        }

        function showNextCardFromQueue() {
            if (cardQueue.length === 0) {
                // Si la cola est√° vac√≠a, intentar cargar m√°s tarjetas
                console.log("‚ö†Ô∏è Cola vac√≠a, cargando tarjeta directamente del servidor...");
                loadNextCard();
                return;
            }
            
            // Tomar la primera tarjeta de la cola
            const nextCard = cardQueue.shift();
            console.log(`üé¥ Mostrando tarjeta desde la cola. ID: ${nextCard.cardId}. Quedan ${cardQueue.length} en cola.`);
            
            // Actualizar la UI con la tarjeta
            currentCardId = nextCard.cardId;
            document.getElementById('question').textContent = nextCard.question;
            document.getElementById('answer').textContent = nextCard.answer;
            resetCardUI();
            
            // Si la cola est√° casi vac√≠a (menos de 2 tarjetas), cargar m√°s en segundo plano
            if (cardQueue.length < 2) {
                console.log("‚ö†Ô∏è Cola casi vac√≠a (menos de 2 tarjetas), solicitando m√°s en segundo plano...");
                loadCardBatch();
            }
        }

        async function loadNextCard() {
            const response = await fetch('/next-card');
            const data = await response.json();
            if (response.ok) {
                currentCardId = data.cardId;
                document.getElementById('question').textContent = data.question;
                document.getElementById('answer').textContent = data.answer;
                document.getElementById('front').classList.remove('hidden');
                document.getElementById('back').classList.add('hidden');
                document.getElementById('show-answer').classList.remove('hidden');
                const answerButtons = document.getElementById('answer-buttons');
                answerButtons.classList.add('hidden');
                answerButtons.style.display = 'none';
            } else {
                if (data.error === "No more cards") {
                    document.getElementById('practice-content').classList.add('hidden');
                    document.getElementById('practice-complete').classList.remove('hidden');
                } else {
                    alert('Error loading next card: ' + data.error);
                }
            }
        }

        document.getElementById('show-answer').addEventListener('click', function() {
            document.getElementById('back').classList.remove('hidden');
            document.getElementById('show-answer').classList.add('hidden');
            const answerButtons = document.getElementById('answer-buttons');
            answerButtons.classList.remove('hidden');
            answerButtons.style.display = 'block';
        });

        async function answerCard(ease) {
            console.log(`üìù Respondiendo tarjeta ${currentCardId} con dificultad: ${ease}`);
            const response = await fetch('/answer-card', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cardId: currentCardId,
                    ease: ease
                })
            });
            const data = await response.json();
            if (data.success) {
                // Verificar si la pr√°ctica est√° completa
                if (data.isPracticeComplete) {
                    console.log("üéâ Pr√°ctica completa. No hay m√°s tarjetas para revisar.");
                    document.getElementById('practice-content').classList.add('hidden');
                    document.getElementById('practice-complete').classList.remove('hidden');
                    return;
                }
                
                // Si tenemos tarjetas en la cola, usar la siguiente de la cola
                if (cardQueue.length > 0) {
                    console.log("‚úÖ Usando siguiente tarjeta de la cola local");
                    showNextCardFromQueue();
                }
                // Si no hay tarjetas en la cola pero hay una tarjeta en la respuesta, usarla
                else if (data.nextCard) {
                    console.log("‚ÑπÔ∏è Cola vac√≠a, usando tarjeta de la respuesta del servidor");
                    currentCardId = data.nextCard.cardId;
                    document.getElementById('question').textContent = data.nextCard.question;
                    document.getElementById('answer').textContent = data.nextCard.answer;
                    resetCardUI();
                    
                    // Intentar cargar m√°s tarjetas en segundo plano
                    console.log("üîÑ Solicitando m√°s tarjetas en segundo plano...");
                    loadCardBatch();
                } else {
                    // Si por alguna raz√≥n no hay datos de la siguiente tarjeta pero la pr√°ctica no est√° completa
                    console.log("‚ö†Ô∏è No hay tarjeta en la respuesta, intentando cargar del servidor...");
                    loadNextCard();
                }
            } else {
                console.error("‚ùå Error al enviar respuesta:", data.error);
                alert('Error submitting answer');
            }
        }
        
        function resetCardUI() {
            document.getElementById('front').classList.remove('hidden');
            document.getElementById('back').classList.add('hidden');
            document.getElementById('show-answer').classList.remove('hidden');
            const answerButtons = document.getElementById('answer-buttons');
            answerButtons.classList.add('hidden');
            answerButtons.style.display = 'none';
        }

        // Start practice when page loads
        window.addEventListener('load', startPractice);
    </script>
</body>
</html>
