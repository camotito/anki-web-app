<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anki Web - Practice</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <div style="text-align: right; margin-bottom: 20px;">
            <a href="/logout" class="button" style="color: white; background-color: #007BFF; padding: 10px 20px; border-radius: 5px; text-decoration: none;">Logout</a>
        </div>
        <div id="card-container">
            <div id="no-cards-due" class="hidden" style="text-align: center;">
                <h2>üìÖ No Cards Due</h2>
                <p>You're all caught up! There are no cards due for review right now.</p>
                {% if next_review %}
                <p>Next review scheduled for: <strong>{{ next_review.strftime('%Y-%m-%d %H:%M') }}</strong></p>
                {% else %}
                <p>All your cards have been reviewed. They will become available based on their spaced repetition schedule.</p>
                {% endif %}
            </div>
            <div id="practice-complete" class="hidden" style="text-align: center;">
                <h2>üéâ Practice Complete! üéâ</h2>
                <p>Great job! You've reviewed all your due cards.</p>
                <p>Come back later when cards are ready for review according to their spaced repetition schedule.</p>
            </div>
            <div id="practice-content">
                <div id="card">
                    <div id="front" class="card-side">
                        <p id="question"></p>
                    </div>
                    <div id="back" class="card-side hidden">
                        <p id="answer"></p>
                    </div>
                </div>
                <button id="show-answer" class="button">Show Answer</button>
                <div id="answer-buttons" class="hidden" style="display: none;">
                    <button class="button again" onclick="answerCard(1)">Imposible</button>
                    <button class="button hard" onclick="answerCard(2)">Hard</button>
                    <button class="button good" onclick="answerCard(3)">Good</button>
                    <button class="button easy" onclick="answerCard(4)">Easy</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCardId = null;
        let cardQueue = []; // Cola de tarjetas precargadas
        let totalCardsInSession = 0; // Total de tarjetas en la sesi√≥n
        let remainingCardsToLoad = 0; // Tarjetas que quedan por cargar del servidor

        async function startPractice() {
            const response = await fetch('/start-practice');
            const data = await response.json();
            if (data.success) {
                // Cargar un lote de tarjetas inmediatamente
                await loadCardBatch();
                // Mostrar la primera tarjeta
                showNextCardFromQueue();
            } else if (data.error === "No cards due for review") {
                document.getElementById('practice-content').classList.add('hidden');
                document.getElementById('no-cards-due').classList.remove('hidden');
            } else {
                alert('Error: ' + data.error);
            }
        }

        async function loadCardBatch() {
            try {
                console.log("üîÑ Solicitando nuevo lote de tarjetas...");
                const response = await fetch('/card-batch');
                const data = await response.json();
                if (response.ok) {
                    // Actualizar informaci√≥n sobre el estado de la sesi√≥n
                    remainingCardsToLoad = data.remainingCards;
                    
                    // Si es la primera carga, guardar el total de tarjetas
                    if (totalCardsInSession === 0 && data.totalCards) {
                        totalCardsInSession = data.totalCards;
                        console.log(`üìä Total de tarjetas en esta sesi√≥n: ${totalCardsInSession}`);
                    }
                    
                    // A√±adir las nuevas tarjetas a la cola
                    cardQueue = cardQueue.concat(data.cards);
                    console.log(`‚úÖ Lote cargado: ${data.cards.length} tarjetas a√±adidas a la cola. Total en cola: ${cardQueue.length}`);
                    console.log(`‚ÑπÔ∏è Tarjetas restantes por cargar: ${remainingCardsToLoad}`);
                    
                    // Verificar si la pr√°ctica est√° completa (no hay m√°s tarjetas por cargar y la cola est√° vac√≠a)
                    checkIfPracticeComplete();
                    
                    return remainingCardsToLoad > 0;
                }
                return false;
            } catch (error) {
                console.error("‚ùå Error loading card batch:", error);
                return false;
            }
        }

        function showNextCardFromQueue() {
            if (cardQueue.length === 0) {
                // Verificar si la pr√°ctica est√° completa
                if (remainingCardsToLoad === 0) {
                    console.log("üéâ Pr√°ctica completa. No hay m√°s tarjetas para revisar.");
                    document.getElementById('practice-content').classList.add('hidden');
                    document.getElementById('practice-complete').classList.remove('hidden');
                    return;
                }
                
                // Si la cola est√° vac√≠a pero quedan tarjetas, intentar cargar m√°s
                console.log("‚ö†Ô∏è Cola vac√≠a, cargando tarjeta directamente del servidor...");
                loadNextCard();
                return;
            }
            
            // Tomar la primera tarjeta de la cola
            const nextCard = cardQueue.shift();
            console.log(`üé¥ Mostrando tarjeta weeee desde la cola. ID: ${nextCard.cardId}. Quedan ${cardQueue.length} en cola.`);
            
            // Actualizar la UI con la tarjeta
            currentCardId = nextCard.cardId;
            document.getElementById('question').textContent = nextCard.question;
            document.getElementById('answer').textContent = nextCard.answer;
            resetCardUI();
            
            // Verificar si la pr√°ctica est√° completa despu√©s de mostrar una tarjeta
            checkIfPracticeComplete();
            
            // Si la cola est√° casi vac√≠a (menos de 2 tarjetas), cargar m√°s en segundo plano
            if (cardQueue.length < 2 && remainingCardsToLoad > 0) {
                console.log("‚ö†Ô∏è Cola casi vac√≠a (menos de 2 tarjetas), solicitando m√°s en segundo plano...");
                loadCardBatch();
            }
        }

        async function loadNextCard() {
            const response = await fetch('/next-card');
            const data = await response.json();
            if (response.ok) {
                currentCardId = data.cardId;
                document.getElementById('question').textContent = data.question;
                document.getElementById('answer').textContent = data.answer;
                document.getElementById('front').classList.remove('hidden');
                document.getElementById('back').classList.add('hidden');
                document.getElementById('show-answer').classList.remove('hidden');
                const answerButtons = document.getElementById('answer-buttons');
                answerButtons.classList.add('hidden');
                answerButtons.style.display = 'none';
            } else {
                if (data.error === "No more cards") {
                    document.getElementById('practice-content').classList.add('hidden');
                    document.getElementById('practice-complete').classList.remove('hidden');
                } else {
                    alert('Error loading next card: ' + data.error);
                }
            }
        }

        document.getElementById('show-answer').addEventListener('click', function() {
            document.getElementById('back').classList.remove('hidden');
            document.getElementById('show-answer').classList.add('hidden');
            const answerButtons = document.getElementById('answer-buttons');
            answerButtons.classList.remove('hidden');
            answerButtons.style.display = 'block';
        });

        function answerCard(ease) {
            console.log(`üìù Respondiendo tarjeta ${currentCardId} con dificultad: ${ease}`);
            
            // Guardar el ID de la tarjeta actual para la petici√≥n
            const cardIdToSubmit = currentCardId;
            
            // Mostrar la siguiente tarjeta inmediatamente, sin esperar la respuesta del servidor
            if (cardQueue.length > 0) {
                console.log("‚úÖ Mostrando siguiente tarjeta de la cola inmediatamente");
                showNextCardFromQueue();
            } else {
                console.log("‚ö†Ô∏è Cola vac√≠a, intentando cargar m√°s tarjetas...");
                // Intentar cargar m√°s tarjetas en segundo plano
                loadCardBatch();
                // Como no hay tarjetas en la cola, intentar cargar la siguiente del servidor
                loadNextCard();
            }
            
            // Enviar la respuesta al servidor en segundo plano (no esperamos la respuesta)
            fetch('/answer-card', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cardId: cardIdToSubmit,
                    ease: ease
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar informaci√≥n sobre la actualizaci√≥n de la tarjeta
                    if (data.card_update) {
                        console.log("üìä Actualizaci√≥n de tarjeta:", data.card_update);
                        console.log(`üìà Tarjeta: ${data.card_update.spanish} - ${data.card_update.english}`);
                        console.log(`üìã Calidad: ${data.card_update.quality}`);
                        console.log(`‚è∞ Pr√≥xima revisi√≥n: ${new Date(data.card_update.new_values.next_review).toLocaleString()}`);
                        console.log(`üìä Factor de facilidad: ${data.card_update.old_values.easiness_factor} ‚Üí ${data.card_update.new_values.easiness_factor}`);
                        console.log(`üìä Intervalo: ${data.card_update.old_values.interval} ‚Üí ${data.card_update.new_values.interval} d√≠as`);
                        console.log(`üìä Repeticiones: ${data.card_update.old_values.repetitions} ‚Üí ${data.card_update.new_values.repetitions}`);
                    }
                    
                    // Intentar cargar m√°s tarjetas en segundo plano si la cola est√° casi vac√≠a
                    if (cardQueue.length < 3) {
                        console.log("üîÑ Solicitando m√°s tarjetas en segundo plano...");
                        loadCardBatch();
                    }
                } else {
                    console.error("‚ùå Error al enviar respuesta:", data.error);
                    // No mostrar alerta para no interrumpir la experiencia del usuario
                }
            })
            .catch(error => {
                console.error("‚ùå Error en la petici√≥n:", error);
                // No mostrar alerta para no interrumpir la experiencia del usuario
            });
        }
        
        function resetCardUI() {
            document.getElementById('front').classList.remove('hidden');
            document.getElementById('back').classList.add('hidden');
            document.getElementById('show-answer').classList.remove('hidden');
            const answerButtons = document.getElementById('answer-buttons');
            answerButtons.classList.add('hidden');
            answerButtons.style.display = 'none';
        }
        
        function checkIfPracticeComplete() {
            // La pr√°ctica est√° completa si no hay m√°s tarjetas por cargar y la cola est√° vac√≠a
            if (remainingCardsToLoad === 0 && cardQueue.length === 0) {
                console.log("üéâ Pr√°ctica completa. No hay m√°s tarjetas para revisar.");
                document.getElementById('practice-content').classList.add('hidden');
                document.getElementById('practice-complete').classList.remove('hidden');
                return true;
            }
            return false;
        }

        // Start practice when page loads
        window.addEventListener('load', startPractice);
    </script>
</body>
</html>
